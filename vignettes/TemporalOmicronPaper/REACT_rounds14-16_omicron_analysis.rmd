---
title: "Fitting Omicron vs Delta P-spline to REACT-1 data for rounds 14-18"
author: "Oliver Eales"
date: "17 May, 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load reactidd}
library(reactidd)
```

# Loading the Data
First we will load the REACT data available using reactidd::load_example_data() 

```{r loading the react data}
pos <- load_example_data_weighted()[[1]]
tot <- load_example_data_weighted()[[2]]

lins <- read.csv(system.file("extdata", "variants.csv", package = "reactidd"))
lins$Omicron <- lins$BA.1 + lins$BA.1.1 + lins$BA.2
lins$X <- as.Date(lins$X)


```

In order to subset the data we define the dates for rounds 14 to 18 of the study
```{r setting the minimum and maximum dates}
min_date_r14 <- as.Date("2021-09-09")
max_date_r18 <- as.Date("2022-03-03")
```



# Fitting the Bayesian P-Spline Model to the data
We can then fit the Bayesian P-spline model to all of the REACT data for the first 7 rounds of the study (iterations and warmup will need to be bigger for accurate estimates)

```{r Fitting the p-spline model, results='hide'}

p_spline_mod_react <- stan_p_spline_weighted_two_variants(pos[pos$X>=min_date_r14 & pos$X<= max_date_r18,]$X,
                                   pos[pos$X>=min_date_r14 & pos$X<= max_date_r18,]$England,
                                   tot[tot$X>=min_date_r14 & tot$X<= max_date_r18,]$England,
                                   lins[c("X","Delta","Omicron"),],
                                   target_dist_between_knots = 5,
                                   spline_degree = 3,
                                   iter = 5000,
                                   warmup = 500,
                                   cores = 1)


```

The p-spline model can then be plotted with estimated 95%CI and 50%CI (the raw data used to produced the plots are avialble by using [[2]] and [[3]] instead of [[1]])
```{r Plotting the p-spline model}
p_spline_plot <- plot_p_spline_prev(pos[pos$X>=min_date_r1 & pos$X<= max_date_r7,]$X,
                                   pos[pos$X>=min_date_r1 & pos$X<= max_date_r7,]$England,
                                   tot[tot$X>=min_date_r1 & tot$X<= max_date_r7,]$England,
                                   p_spline_fit = p_spline_mod_react, 
                                    target_dist_between_knots = 5,
                                    spline_degree = 3,
                                   ylim = 2.0)

print(p_spline_plot[[1]])


```

From the p-spline model we can estimate the date of minimum prevalence and plot the posterior probability density

```{r Date of minimum from P-Spline model}
p_spline_min_date <- plot_p_spline_minimum_density(X = pos[pos$X>=min_date_r1 & pos$X<= max_date_r7,]$X,
                                   p_spline_fit = p_spline_mod_react, 
                                    target_dist_between_knots = 5,
                                    spline_degree = 3)

print(p_spline_min_date[[1]])


```
We can then calculate and plot the instanteous growth rate over the study period

```{r Instantaneous growth rate calculation}
p_spline_igr <- plot_p_spline_igr(X = pos[pos$X>=min_date_r1 & pos$X<= max_date_r7,]$X,
                                   p_spline_fit = p_spline_mod_react, 
                                    target_dist_between_knots = 5,
                                    spline_degree = 3,
                                  ylim = 0.2)

print(p_spline_igr[[1]])


```
and also the rolling two week average Reproduction number
```{r Reproduction number calculation}
p_spline_Rt <- plot_p_spline_R(X = pos[pos$X>=min_date_r1 & pos$X<= max_date_r7,]$X,
                                   p_spline_fit = p_spline_mod_react, 
                                    target_dist_between_knots = 5,
                                    spline_degree = 3)

print(p_spline_Rt[[1]])


```
From the Bayeisan P-spline posterior we can also calculate the average growth rate over periods of time covering individual and subsequent rounds.

```{r average Reproduction number calculation}

```
